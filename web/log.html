<html>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/1.0.21/jquery.csv.min.js"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<body><div><a href="https://github.com/shalzuth/LostArkLogger">Github</a>
<a href="https://discord.gg/MedRDjEwHZ">Discord</a></div>
<button onclick="download()">Download log</button>
<table class="columns">
	<tr>
		<td><select id="encounterList"><option>All Encounters</option></select>
		<td>
	<tr>
		<td><div id="bosspie"></div></td>
		<td><div id="bossbar"></div></td>
	</tr>
	<tr>
		<td><div id="p1pie"></div></td>
		<td><div id="p1bar"></div></td>
		<td><div id="p2pie"></div></td>
		<td><div id="p2bar"></div></td>
	</tr>
	<tr>
		<td><div id="p3pie"></div></td>
		<td><div id="p3bar"></div></td>
		<td><div id="p4pie"></div></td>
		<td><div id="p4bar"></div></td>
	</tr>
</table></body>
<script>
google.charts.load('current', {'packages':['corechart']});
google.charts.setOnLoadCallback(loadData);
function drawChart2(chartDiv, title, rows) {
	var data = new google.visualization.DataTable();
	data.addColumn('string', 'Class');
	data.addColumn('number', 'Damage');
	data.addRows(rows);
	var options = {'title': title, 'width':400, 'height':300};
	var chart = new google.visualization.PieChart(document.getElementById(chartDiv));
	chart.draw(data, options);
}
var colors = ["#3366cc", "#dc3912", "#ff9900", "#109618", "#990099", "#0099c6", "#dd4477", "#66aa00", "#b82e2e", "#316395", "#994499", "#22aa99", "#aaaa11", "#6633cc", "#e67300",
 "#8b0707", "#651067", "#329262", "#5574a6", "#3b3eac", "#b77322", "#16d620", "#b91383", "#f4359e", "#9c5935", "#a9c413", "#2a778d", "#668d1c", "#bea413", "#0c5922", "#743411"];
var selectedPlayer = 'none';
function drawChart(divId, title, rows, level) {
	var data = new google.visualization.DataTable();
	data.addColumn('string', 'Class');
	data.addColumn('number', 'Damage');
	data.addColumn({type:'string', role:'annotation'});
	data.addColumn({type:'string', role:'style'});
	rows.sort((a, b) => { return b[1] - a[1]; } );
	for(var i = 0; i < rows.length; i++)
	{
		var row = rows[i];
		row[2] = row[0];
		row[3] = colors[i % colors.length];
		data.addRow(row);
	}
	//data.addRows(rows);
	//var options = {'title': title, 'width':400, 'height':300};
	var pieOptions = {
        title: title,
        width: 400,
        height: 300,
        bar: {groupWidth: "95%"},
        legend: { position: "none" },
		//colors: colors
      };
	var barOptions = {
        width: 400,
        height: 300,
        bar: {groupWidth: "95%"},
        legend: { position: "none" },
		vAxis: { textPosition: 'none' },
      };
	var piechart = new google.visualization.PieChart(document.getElementById(divId + 'pie'));
	piechart.draw(data, pieOptions);
	var barchart = new google.visualization.BarChart(document.getElementById(divId + 'bar'));
	barchart.draw(data, barOptions);
	
	function pieSelect() {
		var selectedItem = piechart.getSelection()[0];
		if (selectedItem) {
			var character = data.getValue(selectedItem.row, 0);
			var damage = data.getValue(selectedItem.row, 1);
			barchart.setSelection([{'row':selectedItem.row}]);
			selectedPlayer = character;
			setPlayer();
		}
	}
	function barSelect() {
		var selectedItem = barchart.getSelection()[0];
		if (selectedItem) {
			var character = data.getValue(selectedItem.row, 0);
			piechart.setSelection([{'row':selectedItem.row}]);
			selectedPlayer = character;
			setPlayer();
		}
	}
	if (divId == 'boss'){
		google.visualization.events.addListener(piechart, 'select', pieSelect);
		google.visualization.events.addListener(barchart, 'select', barSelect);
	}
}
$.extend({
	distinctObj:function(obj,propertyIndex) {
		var result = [];
		$.each(obj,function(index,value){
			var prop=value[propertyIndex];
			if ($.inArray(prop, result) == -1) result.push(prop);
		});
		return result;
	}
});
$('#encounterList').change(function() {
	setEncounter();
});
var globalData = [];
function setEncounter() {
	var target = $('#encounterList option:selected').text();
    var targets = $.distinctObj(globalData,2);	
	var attackerDamage = [];
	$.each(globalData,function(i,line){
		if (target == 'All Encounters' || target == line[2]){
			if (attackerDamage[line[1]] == null) attackerDamage[line[1]] = 0;
			attackerDamage[line[1]] += parseInt(line[4]);
		}		
	});	
	var above0 = [];
	$.each(targets,function(i,target){ if(attackerDamage[target] > 6000000) above0[target] = attackerDamage[target]; });
	var attackerRows = Object.entries(above0);
	drawChart("boss", $('#encounterList option:selected').text(), attackerRows);
	setPlayer();
}
function setPlayer() {

	var target = $('#encounterList option:selected').text();
	var targets = $.distinctObj(globalData,2);	
	if (selectedPlayer == 'none'){
		var attackerDamage = [];
		$.each(globalData,function(i,line){ if (target == 'All Encounters' || target == line[2]){ if (attackerDamage[line[1]] == null) attackerDamage[line[1]] = 0; attackerDamage[line[1]] += parseInt(line[4]); }});
		
		var attackers = [];
		$.each(targets,function(i,target){ if(attackerDamage[target] > 0) attackers[target] = attackerDamage[target]; });
		
		var attackerSkillDmg = [];
		$.each(targets,function(i,target){
			if (attackers[target] > 0){
				$.each(globalData,function(i,line){
					if (line[1] == target){
						if (attackerSkillDmg[line[1]] == null) attackerSkillDmg[line[1]] = [];
						if (attackerSkillDmg[line[1]][line[3]] == null) attackerSkillDmg[line[1]][line[3]] = 0;
						attackerSkillDmg[line[1]][line[3]] += parseInt(line[4]);
					}
				});
			}
		});
		var idx = 1;
		$.each(targets,function(i,victim){	
			if (idx >= 5) return;
			if (attackers[victim] > 0){
				var skills = Object.entries(attackerSkillDmg[victim]);
				skills = skills.sort(function(a,b) { return b[1] - a[1]; });
				drawChart("p" + idx++, victim, skills);
			}
		});
	}
	else{
		var attackerSkillDmg = [];
		$.each(globalData,function(i,line){
			if ((target == 'All Encounters' || target == line[2]) && line[1] == selectedPlayer){
				if (attackerSkillDmg[line[3]] == null) attackerSkillDmg[line[3]] = 0;
				attackerSkillDmg[line[3]] += parseInt(line[4]);
			}
		});
		var skills = Object.entries(attackerSkillDmg);
		skills = skills.sort(function(a,b) { return b[1] - a[1]; });
		drawChart("p1", selectedPlayer, skills);
	}
}
function processData(data) {
	globalData = data;
    var targets = $.distinctObj(data,2);
	$.each(targets,function(i,target){$('#encounterList').append('<option>' + target + '</option>');});
	setEncounter();
	return;
	//console.log(targets);
	var targetReceivedDamage = [];
	$.each(data,function(i,line){ if (targetReceivedDamage[line[2]] == null) targetReceivedDamage[line[2]] = 0; targetReceivedDamage[line[2]] += parseInt(line[4]); });
	//console.log(targetReceivedDamage);
	var maxTarget = targets[0];
	var maxDmg = targetReceivedDamage[maxTarget];
	//$.each(targets,function(i,target){console.log([target] + " : " + targetReceivedDamage[target]);if (targetReceivedDamage[target]>maxDmg){maxDmg = targetReceivedDamage[target];maxTarget=target;}});
	$.each(targets,function(i,target){if (targetReceivedDamage[target]>maxDmg){maxDmg = targetReceivedDamage[target];maxTarget=target;}});
	//console.log(maxTarget + " : " + maxDmg);
	
	var attackerDamage = [];
	$.each(data,function(i,line){ if (line[2] == maxTarget){ if (attackerDamage[line[1]] == null) attackerDamage[line[1]] = 0; attackerDamage[line[1]] += parseInt(line[4]); }});
	
	var attackers = [];
	$.each(targets,function(i,target){ if(attackerDamage[target] > 0) attackers[target] = attackerDamage[target]; });
	//console.log(attackers);

	var attackerRows = Object.entries(attackers);
	//console.log(attackerRows);
	drawChart("boss", maxTarget, attackerRows);
	
	var attackerSkillDmg = [];
	$.each(targets,function(i,target){
		if (attackers[target] > 0){
			$.each(data,function(i,line){
				if (line[1] == target){
					if (attackerSkillDmg[line[1]] == null) attackerSkillDmg[line[1]] = [];
					if (attackerSkillDmg[line[1]][line[3]] == null) attackerSkillDmg[line[1]][line[3]] = 0;
					attackerSkillDmg[line[1]][line[3]] += parseInt(line[4]);
				}
			});
		}
	});
	var idx = 1;
	$.each(targets,function(i,target){	
		if (attackers[target] > 0){
			var skills = Object.entries(attackerSkillDmg[target]);
			skills = skills.sort(function(a,b) { return b[1] - a[1]; });
			//drawChart("p" + idx++, target, skills);
		}
	});
	//console.log(attackerSkillDmg);
}
var guid = window.location.pathname.substring(window.location.pathname.lastIndexOf('/') + 1)
var csv = [];
function loadData(){
	csvData = $.ajax({
		type: "GET",
		url: "/download/" + guid,
		//dataType: "text/csv",
		success: function () {
			csv = csvData.responseText;
			//console.log($.csv.toArrays(csvData.responseText));
			processData($.csv.toArrays(csvData.responseText));
		   //alert("done!"+ csvData.getAllResponseHeaders())
		 }
	});
}
function download() {
	var pom = document.createElement('a');
	pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(csv));
	pom.setAttribute('download', guid + ".log");
	if(document.createEvent) {
		var event = document.createEvent('MouseEvents');
		event.initEvent('click', true, true);
		pom.dispatchEvent(event);
	} else {
		pom.click();
	}
}
</script>
</html>